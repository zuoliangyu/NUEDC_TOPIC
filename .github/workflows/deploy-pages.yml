name: è‡ªåŠ¨éƒ¨ç½²åˆ° GitHub Pages

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

# å…è®¸æ‰‹åŠ¨è§¦å‘å·¥ä½œæµ
  workflow_dispatch:

# è®¾ç½® GITHUB_TOKEN çš„æƒé™
permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  # æ„å»ºå’Œéƒ¨ç½²ä»»åŠ¡
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: å®‰è£… docsify-cli
        run: npm i docsify-cli -g

      - name: åˆ›å»ºæ„å»ºç›®å½•
        run: mkdir -p dist

      - name: å¤åˆ¶æ–‡æ¡£æ–‡ä»¶
        run: |
          cp README.md dist/
          cp -r çœŸé¢˜ dist/
          cp -r assets dist/
          cp -r ç»¼åˆæµ‹è¯„ dist/

      - name: ç”Ÿæˆå„å¹´ä»½ç›®å½•çš„READMEæ–‡ä»¶
        run: |
          # ä¸ºæ¯ä¸ªå¹´ä»½ç›®å½•åˆ›å»ºREADME.mdæ–‡ä»¶
          for year_dir in dist/çœŸé¢˜/*/; do
            if [ -d "$year_dir" ]; then
              year=$(basename "$year_dir")
              echo "æ­£åœ¨ä¸º $year å¹´ç”ŸæˆREADMEæ–‡ä»¶..."
              
              cat > "${year_dir}README.md" << EOF
          # ${year}å¹´å…¨å›½å¤§å­¦ç”Ÿç”µå­è®¾è®¡ç«èµ›é¢˜ç›®
          
          ## ğŸ“‹ é¢˜ç›®åˆ—è¡¨
          
          EOF
              
              # åˆ—å‡ºè¯¥å¹´ä»½ç›®å½•ä¸‹çš„æ‰€æœ‰é¢˜ç›®æ–‡ä»¶
              find "$year_dir" -name "*.pdf" -o -name "*.doc" -o -name "*.docx" -o -name "*.jpg" -o -name "*.zip" | sort | while read file; do
                filename=$(basename "$file")
                # ç§»é™¤æ–‡ä»¶æ‰©å±•åä½œä¸ºé¢˜ç›®åç§°
                title=$(echo "$filename" | sed 's/\.[^.]*$//')
                echo "- [$title]($filename)" >> "${year_dir}README.md"
              done
              
              cat >> "${year_dir}README.md" << EOF
          
          ## ğŸ“– ä½¿ç”¨è¯´æ˜
          
          ç‚¹å‡»ä¸Šæ–¹é¢˜ç›®é“¾æ¥å¯ç›´æ¥æŸ¥çœ‹PDFæ–‡ä»¶ã€‚å¦‚æœæ˜¯å›¾ç‰‡æ–‡ä»¶ï¼Œå°†åœ¨æ–°çª—å£ä¸­æ‰“å¼€é¢„è§ˆã€‚
          
          ---
          
          [ğŸ”™ è¿”å›é¦–é¡µ](/)
          EOF
            fi
          done
          
          # ä¸ºç»¼åˆæµ‹è¯„ç›®å½•åˆ›å»ºREADMEæ–‡ä»¶
          if [ -d "dist/ç»¼åˆæµ‹è¯„/" ]; then
            echo "æ­£åœ¨ä¸ºç»¼åˆæµ‹è¯„ç”ŸæˆREADMEæ–‡ä»¶..."
            
            cat > "dist/ç»¼åˆæµ‹è¯„/README.md" << 'EOF'
          # å…¨å›½å¤§å­¦ç”Ÿç”µå­è®¾è®¡ç«èµ›ç»¼åˆæµ‹è¯„é¢˜ç›®
          
          ## ğŸ“‹ å†å¹´ç»¼åˆæµ‹è¯„é¢˜ç›®
          
          EOF
            
            # éå†ç»¼åˆæµ‹è¯„ç›®å½•ä¸‹çš„æ¯ä¸ªå¹´ä»½å­ç›®å½•
            for subdir in dist/ç»¼åˆæµ‹è¯„/*/; do
              if [ -d "$subdir" ]; then
                dirname=$(basename "$subdir")
                echo "å¤„ç†ç»¼åˆæµ‹è¯„å­ç›®å½•: $dirname"
                
                # æŸ¥æ‰¾è¯¥å­ç›®å½•ä¸‹çš„PDFæ–‡ä»¶
                pdf_file=$(find "$subdir" -name "*.pdf" | head -1)
                if [ -n "$pdf_file" ]; then
                  pdf_filename=$(basename "$pdf_file")
                  pdf_title=$(echo "$pdf_filename" | sed 's/\.pdf$//')
                  echo "- [$pdf_title]($dirname/$pdf_filename)" >> "dist/ç»¼åˆæµ‹è¯„/README.md"
                fi
                
                # æ£€æŸ¥æ˜¯å¦æœ‰ä»¿çœŸæ–‡ä»¶ï¼ˆ.ms13, .ms14ç­‰ï¼‰
                sim_files=$(find "$subdir" -name "*.ms*" | head -1)
                if [ -n "$sim_files" ]; then
                  echo "  - [ä»¿çœŸæ–‡ä»¶]($dirname/)" >> "dist/ç»¼åˆæµ‹è¯„/README.md"
                  
                  # ä¸ºè¯¥å­ç›®å½•åˆ›å»ºREADMEæ–‡ä»¶ï¼Œåˆ—å‡ºæ‰€æœ‰ä»¿çœŸæ–‡ä»¶
                  cat > "${subdir}README.md" << SUBEOF
          # $dirname ä»¿çœŸæ–‡ä»¶
          
          ## ğŸ“‹ ä»¿çœŸæ–‡ä»¶åˆ—è¡¨
          
          SUBEOF
                  
                  # åˆ—å‡ºè¯¥å­ç›®å½•ä¸‹çš„æ‰€æœ‰ä»¿çœŸæ–‡ä»¶
                  find "$subdir" -name "*.ms*" -o -name "*.slx" -o -name "*.png" -o -name "*.jpg" -o -name "*.docx" | sort | while read file; do
                    filename=$(basename "$file")
                    title=$(echo "$filename" | sed 's/\.[^.]*$//')
                    echo "- [$title]($filename)" >> "${subdir}README.md"
                  done
                  
                  cat >> "${subdir}README.md" << SUBEOF
          
          ## ğŸ“– ä½¿ç”¨è¯´æ˜
          
          è¿™äº›æ˜¯ $dirname å¹´åº¦ç»¼åˆæµ‹è¯„çš„ä»¿çœŸæ–‡ä»¶ï¼ŒåŒ…æ‹¬ï¼š
          - Multisimä»¿çœŸç”µè·¯æ–‡ä»¶ (.ms13, .ms14)
          - Matlab/Simulinkä»¿çœŸæ–‡ä»¶ (.slx)
          - ç”µè·¯å›¾é¢„è§ˆå›¾ç‰‡ (.png, .jpg)
          - ç›¸å…³æ–‡æ¡£ (.docx)
          
          ---
          
          [ğŸ”™ è¿”å›ç»¼åˆæµ‹è¯„](../)
          SUBEOF
                fi
              fi
            done
            
            # åˆ—å‡ºæ ¹ç›®å½•ä¸‹çš„PDFæ–‡ä»¶
            find "dist/ç»¼åˆæµ‹è¯„/" -maxdepth 1 -name "*.pdf" | sort | while read file; do
              filename=$(basename "$file")
              title=$(echo "$filename" | sed 's/\.pdf$//')
              echo "- [$title]($filename)" >> "dist/ç»¼åˆæµ‹è¯„/README.md"
            done
            
            cat >> "dist/ç»¼åˆæµ‹è¯„/README.md" << 'EOF'
          
          ## ğŸ“– å…³äºç»¼åˆæµ‹è¯„
          
          ç»¼åˆæµ‹è¯„æ˜¯å…¨å›½å¤§å­¦ç”Ÿç”µå­è®¾è®¡ç«èµ›çš„é‡è¦ç»„æˆéƒ¨åˆ†ï¼Œä¸»è¦è€ƒæŸ¥å‚èµ›é˜Ÿä¼çš„ç»¼åˆè®¾è®¡èƒ½åŠ›å’Œç†è®ºåŸºç¡€ã€‚
          
          ç‚¹å‡»"ä»¿çœŸæ–‡ä»¶"å¯æŸ¥çœ‹è¯¥å¹´ä»½çš„Multisimä»¿çœŸç”µè·¯ã€‚
          
          ---
          
          [ğŸ”™ è¿”å›é¦–é¡µ](/)
          EOF
          fi

      - name: åˆ›å»º docsify é…ç½®æ–‡ä»¶
        run: |
          cat > dist/index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="zh-CN">
          <head>
            <meta charset="UTF-8">
            <title>å…¨å›½å¤§å­¦ç”Ÿç”µå­è®¾è®¡ç«èµ›å†å¹´çœŸé¢˜</title>
            <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
            <meta name="description" content="å…¨å›½å¤§å­¦ç”Ÿç”µå­è®¾è®¡ç«èµ›å†å¹´çœŸé¢˜åœ¨çº¿æµè§ˆ">
            <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0">
            <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/docsify@4/lib/themes/vue.css">
            <link rel="icon" href="./assets/LOGO/NUEDC_LOGO.jpg">
          </head>
          <body>
            <div id="app">åŠ è½½ä¸­...</div>
            <script>
              window.$docsify = {
                name: 'ç”µèµ›å†å¹´çœŸé¢˜',
                repo: 'https://github.com/zuoliangyu/NUEDC_TOPIC',
                loadSidebar: true,
                subMaxLevel: 3,
                auto2top: true,
                search: {
                  placeholder: 'æœç´¢',
                  noData: 'æ²¡æœ‰æ‰¾åˆ°ç»“æœ',
                  depth: 6
                },
                plugins: [
                  function(hook, vm) {
                    hook.beforeEach(function(html) {
                      return html + '\n\n----\n\n<footer style="text-align: center; margin-top: 20px; padding: 15px; border-top: 1px solid #eee; color: #666;">' +
                        'Â© 2025 å…¨å›½å¤§å­¦ç”Ÿç”µå­è®¾è®¡ç«èµ›å†å¹´çœŸé¢˜<br>' +
                        'ğŸ“ æ•´ç†ç»´æŠ¤ï¼š<strong>å·¦å²š</strong><br>' +
                        'ğŸ“º <a href="https://space.bilibili.com/27619688" target="_blank" style="color: #00a1d6;">å“”å“©å“”å“©ä¸»é¡µ</a> | ' +
                        'ğŸ”— <a href="https://github.com/zuoliangyu/NUEDC_TOPIC" target="_blank">GitHub ä»“åº“</a><br>' +
                        'â° æ›´æ–°æ—¶é—´: ' + new Date().toLocaleString('zh-CN') +
                        '</footer>';
                    });
                  }
                ]
              }
            </script>
            <!-- docsify æ ¸å¿ƒæ–‡ä»¶ -->
            <script src="//cdn.jsdelivr.net/npm/docsify@4"></script>
            <!-- æœç´¢æ’ä»¶ -->
            <script src="//cdn.jsdelivr.net/npm/docsify@4/lib/plugins/search.min.js"></script>
            <!-- ä»£ç é«˜äº® -->
            <script src="//cdn.jsdelivr.net/npm/prismjs@1/components/prism-bash.min.js"></script>
            <!-- PDF åµŒå…¥æ’ä»¶ -->
            <script src="//cdn.jsdelivr.net/npm/docsify-pdf-embed-plugin/src/docsify-pdf-embed.js"></script>
            <!-- å›¾ç‰‡ç¼©æ”¾ -->
            <script src="//cdn.jsdelivr.net/npm/docsify@4/lib/plugins/zoom-image.min.js"></script>
            <!-- å¤åˆ¶åˆ°å‰ªè´´æ¿ -->
            <script src="//cdn.jsdelivr.net/npm/docsify-copy-code@2/dist/docsify-copy-code.min.js"></script>
          </body>
          </html>
          EOF

      - name: ç”Ÿæˆä¾§è¾¹æ 
        run: |
          cat > dist/_sidebar.md << 'EOF'
          * [ğŸ  é¦–é¡µ](/)
          
          <details>
          <summary>ğŸ“š å†å¹´çœŸé¢˜</summary>
          
          EOF
          
          # åŠ¨æ€ç”Ÿæˆå¹´ä»½é“¾æ¥
          for year_dir in dist/çœŸé¢˜/*/; do
            if [ -d "$year_dir" ]; then
              year=$(basename "$year_dir")
              echo "* [$year å¹´](çœŸé¢˜/$year/)" >> dist/_sidebar.md
            fi
          done
          
          cat >> dist/_sidebar.md << 'EOF'
          
          </details>
          
          <details>
          <summary>ğŸ† ç»¼åˆæµ‹è¯„</summary>
          
          * [ç»¼åˆæµ‹è¯„é¢˜ç›®](ç»¼åˆæµ‹è¯„/)
          
          </details>
          
          * ğŸ“– ä½¿ç”¨è¯´æ˜
            * [åœ¨çº¿è®¿é—®åŠŸèƒ½](#åœ¨çº¿è®¿é—®)
            * [GitHub ä»“åº“](https://github.com/zuoliangyu/NUEDC_TOPIC)
          EOF

      - name: åˆ›å»º .nojekyll æ–‡ä»¶
        run: touch dist/.nojekyll

      - name: éƒ¨ç½²åˆ° gh-pages åˆ†æ”¯
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./dist
          publish_branch: gh-pages
          force_orphan: true