name: 自动部署到 GitHub Pages

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

# 允许手动触发工作流
  workflow_dispatch:

# 设置 GITHUB_TOKEN 的权限
permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  # 构建和部署任务
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: 检出代码
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 设置 Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: 安装 docsify-cli
        run: npm i docsify-cli -g

      - name: 创建构建目录
        run: mkdir -p dist

      - name: 复制文档文件
        run: |
          cp README.md dist/
          cp -r 真题 dist/
          cp -r assets dist/
          cp -r 综合测评 dist/

      - name: 生成各年份目录的README文件
        run: |
          # 为每个年份目录创建README.md文件
          for year_dir in dist/真题/*/; do
            if [ -d "$year_dir" ]; then
              year=$(basename "$year_dir")
              echo "正在为 $year 年生成README文件..."
              
              cat > "${year_dir}README.md" << EOF
          # ${year}年全国大学生电子设计竞赛题目
          
          ## 📋 题目列表
          
          EOF
              
              # 列出该年份目录下的所有题目文件
              find "$year_dir" -name "*.pdf" -o -name "*.doc" -o -name "*.docx" -o -name "*.jpg" -o -name "*.zip" | sort | while read file; do
                filename=$(basename "$file")
                # 移除文件扩展名作为题目名称
                title=$(echo "$filename" | sed 's/\.[^.]*$//')
                echo "- [$title]($filename)" >> "${year_dir}README.md"
              done
              
              cat >> "${year_dir}README.md" << EOF
          
          ## 📖 使用说明
          
          点击上方题目链接可直接查看PDF文件。如果是图片文件，将在新窗口中打开预览。
          
          ---
          
          [🔙 返回首页](/)
          EOF
            fi
          done
          
          # 为综合测评目录创建README文件
          if [ -d "dist/综合测评/" ]; then
            echo "正在为综合测评生成README文件..."
            
            cat > "dist/综合测评/README.md" << 'EOF'
          # 全国大学生电子设计竞赛综合测评题目
          
          ## 📋 历年综合测评题目
          
          EOF
            
            # 遍历综合测评目录下的每个年份子目录
            for subdir in dist/综合测评/*/; do
              if [ -d "$subdir" ]; then
                dirname=$(basename "$subdir")
                echo "处理综合测评子目录: $dirname"
                
                # 查找该子目录下的PDF文件
                pdf_file=$(find "$subdir" -name "*.pdf" | head -1)
                if [ -n "$pdf_file" ]; then
                  pdf_filename=$(basename "$pdf_file")
                  pdf_title=$(echo "$pdf_filename" | sed 's/\.pdf$//')
                  echo "- [$pdf_title]($dirname/$pdf_filename)" >> "dist/综合测评/README.md"
                fi
                
                # 检查是否有仿真文件（.ms13, .ms14等）
                sim_files=$(find "$subdir" -name "*.ms*" | head -1)
                if [ -n "$sim_files" ]; then
                  echo "  - [仿真文件]($dirname/)" >> "dist/综合测评/README.md"
                  
                  # 为该子目录创建README文件，列出所有仿真文件
                  cat > "${subdir}README.md" << SUBEOF
          # $dirname 仿真文件
          
          ## 📋 仿真文件列表
          
          SUBEOF
                  
                  # 列出该子目录下的所有仿真文件
                  find "$subdir" -name "*.ms*" -o -name "*.slx" -o -name "*.png" -o -name "*.jpg" -o -name "*.docx" | sort | while read file; do
                    filename=$(basename "$file")
                    title=$(echo "$filename" | sed 's/\.[^.]*$//')
                    echo "- [$title]($filename)" >> "${subdir}README.md"
                  done
                  
                  cat >> "${subdir}README.md" << SUBEOF
          
          ## 📖 使用说明
          
          这些是 $dirname 年度综合测评的仿真文件，包括：
          - Multisim仿真电路文件 (.ms13, .ms14)
          - Matlab/Simulink仿真文件 (.slx)
          - 电路图预览图片 (.png, .jpg)
          - 相关文档 (.docx)
          
          ---
          
          [🔙 返回综合测评](../)
          SUBEOF
                fi
              fi
            done
            
            # 列出根目录下的PDF文件
            find "dist/综合测评/" -maxdepth 1 -name "*.pdf" | sort | while read file; do
              filename=$(basename "$file")
              title=$(echo "$filename" | sed 's/\.pdf$//')
              echo "- [$title]($filename)" >> "dist/综合测评/README.md"
            done
            
            cat >> "dist/综合测评/README.md" << 'EOF'
          
          ## 📖 关于综合测评
          
          综合测评是全国大学生电子设计竞赛的重要组成部分，主要考查参赛队伍的综合设计能力和理论基础。
          
          点击"仿真文件"可查看该年份的Multisim仿真电路。
          
          ---
          
          [🔙 返回首页](/)
          EOF
          fi

      - name: 创建 docsify 配置文件
        run: |
          cat > dist/index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="zh-CN">
          <head>
            <meta charset="UTF-8">
            <title>全国大学生电子设计竞赛历年真题</title>
            <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
            <meta name="description" content="全国大学生电子设计竞赛历年真题在线浏览">
            <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0">
            <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/docsify@4/lib/themes/vue.css">
            <link rel="icon" href="./assets/LOGO/NUEDC_LOGO.jpg">
          </head>
          <body>
            <div id="app">加载中...</div>
            <script>
              window.$docsify = {
                name: '电赛历年真题',
                repo: 'https://github.com/zuoliangyu/NUEDC_TOPIC',
                loadSidebar: true,
                subMaxLevel: 3,
                auto2top: true,
                search: {
                  placeholder: '搜索',
                  noData: '没有找到结果',
                  depth: 6
                },
                plugins: [
                  function(hook, vm) {
                    hook.beforeEach(function(html) {
                      return html + '\n\n----\n\n<footer style="text-align: center; margin-top: 20px; padding: 15px; border-top: 1px solid #eee; color: #666;">' +
                        '© 2025 全国大学生电子设计竞赛历年真题<br>' +
                        '📝 整理维护：<strong>左岚</strong><br>' +
                        '📺 <a href="https://space.bilibili.com/27619688" target="_blank" style="color: #00a1d6;">哔哩哔哩主页</a> | ' +
                        '🔗 <a href="https://github.com/zuoliangyu/NUEDC_TOPIC" target="_blank">GitHub 仓库</a><br>' +
                        '⏰ 更新时间: ' + new Date().toLocaleString('zh-CN') +
                        '</footer>';
                    });
                  }
                ]
              }
            </script>
            <!-- docsify 核心文件 -->
            <script src="//cdn.jsdelivr.net/npm/docsify@4"></script>
            <!-- 搜索插件 -->
            <script src="//cdn.jsdelivr.net/npm/docsify@4/lib/plugins/search.min.js"></script>
            <!-- 代码高亮 -->
            <script src="//cdn.jsdelivr.net/npm/prismjs@1/components/prism-bash.min.js"></script>
            <!-- PDF 嵌入插件 -->
            <script src="//cdn.jsdelivr.net/npm/docsify-pdf-embed-plugin/src/docsify-pdf-embed.js"></script>
            <!-- 图片缩放 -->
            <script src="//cdn.jsdelivr.net/npm/docsify@4/lib/plugins/zoom-image.min.js"></script>
            <!-- 复制到剪贴板 -->
            <script src="//cdn.jsdelivr.net/npm/docsify-copy-code@2/dist/docsify-copy-code.min.js"></script>
          </body>
          </html>
          EOF

      - name: 生成侧边栏
        run: |
          cat > dist/_sidebar.md << 'EOF'
          * [🏠 首页](/)
          
          <details>
          <summary>📚 历年真题</summary>
          
          EOF
          
          # 动态生成年份链接
          for year_dir in dist/真题/*/; do
            if [ -d "$year_dir" ]; then
              year=$(basename "$year_dir")
              echo "* [$year 年](真题/$year/)" >> dist/_sidebar.md
            fi
          done
          
          cat >> dist/_sidebar.md << 'EOF'
          
          </details>
          
          <details>
          <summary>🏆 综合测评</summary>
          
          * [综合测评题目](综合测评/)
          
          </details>
          
          * 📖 使用说明
            * [在线访问功能](#在线访问)
            * [GitHub 仓库](https://github.com/zuoliangyu/NUEDC_TOPIC)
          EOF

      - name: 创建 .nojekyll 文件
        run: touch dist/.nojekyll

      - name: 部署到 gh-pages 分支
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./dist
          publish_branch: gh-pages
          force_orphan: true