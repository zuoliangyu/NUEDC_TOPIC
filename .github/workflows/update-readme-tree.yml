name: Update README Tree

on:
  push:
    branches: [ master, main ]
    paths:
      - 'çœŸé¢˜/**'
      - 'ç»¼åˆæµ‹è¯„/**'
      - 'README.md'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-tree:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
        
    - name: Generate directory tree
      run: |
        # å®‰è£… tree å‘½ä»¤ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
        sudo apt-get update && sudo apt-get install -y tree
        
        # ç”Ÿæˆç›®å½•æ ‘ï¼ŒåªåŒ…å«çœŸé¢˜å’Œç»¼åˆæµ‹è¯„ç›®å½•ï¼Œæ’é™¤ .git å’Œ .github ç›®å½•
        echo "ç”Ÿæˆç›®å½•æ ‘..."
        tree -a -I '.git*|node_modules|*.log' --dirsfirst --charset=ascii > temp_tree.txt
        
        # åˆ›å»ºæ ¼å¼åŒ–çš„ç›®å½•æ ‘è¾“å‡º
        cat > formatted_tree.txt << 'EOF'
        ```
        EOF
        cat temp_tree.txt >> formatted_tree.txt
        cat >> formatted_tree.txt << 'EOF'
        ```
        
        ## ğŸ“Š ç»Ÿè®¡ä¿¡æ¯
        
        EOF
        
        # ç»Ÿè®¡å„ä¸ªå¹´ä»½çš„é¢˜ç›®æ•°é‡
        echo "### ğŸ“… å¹´ä»½ç»Ÿè®¡" >> formatted_tree.txt
        echo "" >> formatted_tree.txt
        for year in $(ls çœŸé¢˜/ | grep -E '^[0-9]{4}$' | sort -n); do
          count=$(find "çœŸé¢˜/$year" -type f \( -name "*.pdf" -o -name "*.doc" -o -name "*.docx" \) | wc -l)
          echo "- **$yearå¹´**: $count ä¸ªé¢˜ç›®" >> formatted_tree.txt
        done
        
        echo "" >> formatted_tree.txt
        echo "### ğŸ“ é¢˜ç›®ç±»å‹ç»Ÿè®¡" >> formatted_tree.txt
        echo "" >> formatted_tree.txt
        
        # ç»Ÿè®¡æ–‡ä»¶ç±»å‹
        pdf_count=$(find çœŸé¢˜/ -name "*.pdf" | wc -l)
        doc_count=$(find çœŸé¢˜/ -name "*.doc" | wc -l) 
        docx_count=$(find çœŸé¢˜/ -name "*.docx" | wc -l)
        xlsx_count=$(find çœŸé¢˜/ -name "*.xlsx" | wc -l)
        
        echo "- **PDFæ–‡ä»¶**: $pdf_count ä¸ª" >> formatted_tree.txt
        echo "- **DOCæ–‡ä»¶**: $doc_count ä¸ª" >> formatted_tree.txt  
        echo "- **DOCXæ–‡ä»¶**: $docx_count ä¸ª" >> formatted_tree.txt
        echo "- **XLSXæ–‡ä»¶**: $xlsx_count ä¸ª" >> formatted_tree.txt
        
        # ç»Ÿè®¡ç»¼åˆæµ‹è¯„é¢˜ç›®
        eval_count=$(find ç»¼åˆæµ‹è¯„/ -name "*.pdf" | wc -l)
        echo "- **ç»¼åˆæµ‹è¯„**: $eval_count ä¸ª" >> formatted_tree.txt
        
        echo "" >> formatted_tree.txt
        echo "> ğŸ“… æœ€åæ›´æ–°: $(date '+%Y-%m-%d %H:%M:%S') UTC" >> formatted_tree.txt
        
        # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        rm temp_tree.txt
        
    - name: Update README
      run: |
        # ä½¿ç”¨ Python è„šæœ¬æ¥æ›¿æ¢ README.md ä¸­çš„å†…å®¹
        python3 << 'EOF'
        import re
        
        # è¯»å–å½“å‰çš„ README.md
        with open('README.md', 'r', encoding='utf-8') as f:
            content = f.read()
        
        # è¯»å–ç”Ÿæˆçš„ç›®å½•æ ‘
        with open('formatted_tree.txt', 'r', encoding='utf-8') as f:
            tree_content = f.read()
        
        # ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼æ›¿æ¢ readme-tree start å’Œ end ä¹‹é—´çš„å†…å®¹
        pattern = r'(<!-- readme-tree start -->).*?(<!-- readme-tree end -->)'
        replacement = r'\1\n\n' + tree_content + r'\n\2'
        
        new_content = re.sub(pattern, replacement, content, flags=re.DOTALL)
        
        # å†™å› README.md
        with open('README.md', 'w', encoding='utf-8') as f:
            f.write(new_content)
        
        print("README.md å·²æ›´æ–°")
        EOF
        
    - name: Commit and push changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # æ£€æŸ¥æ˜¯å¦æœ‰å˜åŒ–
        if git diff --quiet; then
          echo "æ²¡æœ‰æ£€æµ‹åˆ°å˜åŒ–ï¼Œè·³è¿‡æäº¤"
        else
          git add README.md
          git commit -m "ğŸ¤– è‡ªåŠ¨æ›´æ–°ç›®å½•æ ‘ç»“æ„

          ğŸ“Š æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
          ğŸ“… æ›´æ–°æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')
          
          ğŸ¤– Generated with GitHub Actions"
          git push
          echo "README.md å·²æ›´æ–°å¹¶æ¨é€"
        fi