name: ğŸ“š å…¨å›½å¤§å­¦ç”Ÿç”µå­è®¾è®¡ç«èµ›çœŸé¢˜ - è‡ªåŠ¨æ›´æ–°ä¸éƒ¨ç½²

on:
  push:
    branches:
      - master
    paths-ignore:
      - '**.md'
      - '.github/**'
  pull_request:
    branches:
      - master
  workflow_dispatch:
    inputs:
      force_rebuild:
        description: 'å¼ºåˆ¶é‡å»ºæ•´ä¸ªç½‘ç«™'
        required: false
        default: false
        type: boolean

# å£°æ˜å·¥ä½œæµæƒé™
permissions:
  contents: write
  pages: write
  id-token: write
  actions: read

# ç¯å¢ƒå˜é‡
env:
  NODE_VERSION: '18'
  PYTHON_VERSION: '3.11'

jobs:
  # ğŸ” é¢„æ£€æŸ¥ä½œä¸š
  pre-check:
    runs-on: ubuntu-latest
    outputs:
      should_build: ${{ steps.check.outputs.should_build }}
      files_changed: ${{ steps.changes.outputs.files_changed }}
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: ğŸ” æ£€æŸ¥æ–‡ä»¶å˜æ›´
        id: changes
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" && "${{ github.event.inputs.force_rebuild }}" == "true" ]]; then
            echo "files_changed=true" >> $GITHUB_OUTPUT
          else
            # æ£€æŸ¥æ˜¯å¦æœ‰PDFã€DOCç­‰æ–‡ä»¶å˜æ›´
            CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD | grep -E '\.(pdf|doc|docx|xls|xlsx)$' || true)
            if [[ -n "$CHANGED_FILES" ]]; then
              echo "files_changed=true" >> $GITHUB_OUTPUT
              echo "ğŸ“„ æ£€æµ‹åˆ°é¢˜ç›®æ–‡ä»¶å˜æ›´:"
              echo "$CHANGED_FILES"
            else
              echo "files_changed=false" >> $GITHUB_OUTPUT
              echo "â„¹ï¸ æœªæ£€æµ‹åˆ°é¢˜ç›®æ–‡ä»¶å˜æ›´"
            fi
          fi

      - name: ğŸ¯ å†³å®šæ˜¯å¦æ„å»º
        id: check
        run: |
          if [[ "${{ steps.changes.outputs.files_changed }}" == "true" || "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "should_build=true" >> $GITHUB_OUTPUT
            echo "âœ… éœ€è¦æ„å»ºç½‘ç«™"
          else
            echo "should_build=false" >> $GITHUB_OUTPUT
            echo "â­ï¸ è·³è¿‡æ„å»º"
          fi

  # ğŸ“„ æ›´æ–°READMEæ–‡ä»¶æ ‘
  update-readme:
    needs: pre-check
    if: needs.pre-check.outputs.should_build == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ æ£€å‡ºmasteråˆ†æ”¯
        uses: actions/checkout@v4
        with:
          ref: master
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ğŸŒ³ ç”Ÿæˆæ–‡ä»¶æ ‘å’Œä¾§è¾¹æ 
        run: |
          echo "ğŸš€ å¼€å§‹ç”Ÿæˆæ–‡ä»¶æ ‘..."
          python generate_tree.py

      - name: ğŸ“Š æ˜¾ç¤ºç”Ÿæˆçš„æ–‡ä»¶
        run: |
          echo "ğŸ“„ ç”Ÿæˆçš„README.mdç‰‡æ®µ:"
          if grep -A 20 "readme-tree start" README.md; then
            echo "âœ… README.mdåŒ…å«æ–‡ä»¶æ ‘"
          else
            echo "âŒ README.mdæœªåŒ…å«æ–‡ä»¶æ ‘"
          fi
          
          echo "ğŸ“‹ ç”Ÿæˆçš„_sidebar.md:"
          if [[ -f "_sidebar.md" ]]; then
            head -20 _sidebar.md
            echo "âœ… ä¾§è¾¹æ æ–‡ä»¶å·²ç”Ÿæˆ"
          else
            echo "âŒ ä¾§è¾¹æ æ–‡ä»¶æœªç”Ÿæˆ"
          fi

      - name: ğŸ’¾ æäº¤æ–‡ä»¶æ ‘æ›´æ–°
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "ğŸ“š docs: è‡ªåŠ¨æ›´æ–°æ–‡ä»¶æ ‘å’Œä¾§è¾¹æ  [skip ci]"
          branch: master
          file_pattern: 'README.md _sidebar.md'
          commit_user_name: "GitHub Actions"
          commit_user_email: "actions@github.com"
          commit_author: "GitHub Actions <actions@github.com>"

  # ğŸš€ æ„å»ºå¹¶éƒ¨ç½²Docsifyç½‘ç«™
  build-and-deploy:
    needs: [pre-check, update-readme]
    if: needs.pre-check.outputs.should_build == 'true'
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
      - name: ğŸ“¥ æ£€å‡ºæœ€æ–°çš„masteråˆ†æ”¯
        uses: actions/checkout@v4
        with:
          ref: master

      - name: ğŸ è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ğŸ“‹ ç¡®ä¿ä¾§è¾¹æ å­˜åœ¨
        run: |
          if [[ ! -f "_sidebar.md" ]]; then
            echo "âš ï¸ ä¾§è¾¹æ æ–‡ä»¶ä¸å­˜åœ¨ï¼Œç”Ÿæˆä¸­..."
            python generate_tree.py
          else
            echo "âœ… ä¾§è¾¹æ æ–‡ä»¶å­˜åœ¨"
          fi

      - name: ğŸ”§ éªŒè¯Docsifyé…ç½®
        run: |
          echo "ğŸ“„ æ£€æŸ¥å¿…è¦æ–‡ä»¶:"
          
          # æ£€æŸ¥index.html
          if [[ -f "index.html" ]]; then
            echo "âœ… index.html å­˜åœ¨"
          else
            echo "âŒ index.html ä¸å­˜åœ¨"
            exit 1
          fi
          
          # æ£€æŸ¥.nojekyll
          if [[ -f ".nojekyll" ]]; then
            echo "âœ… .nojekyll å­˜åœ¨"
          else
            echo "âš ï¸ åˆ›å»º .nojekyll æ–‡ä»¶"
            touch .nojekyll
          fi
          
          # æ£€æŸ¥_sidebar.md
          if [[ -f "_sidebar.md" ]]; then
            echo "âœ… _sidebar.md å­˜åœ¨ï¼ŒåŒ…å« $(wc -l < _sidebar.md) è¡Œ"
          else
            echo "âŒ _sidebar.md ä¸å­˜åœ¨"
            exit 1
          fi

      - name: ğŸ“¦ å‡†å¤‡éƒ¨ç½²æ–‡ä»¶
        run: |
          echo "ğŸ“ å½“å‰ç›®å½•å†…å®¹:"
          ls -la
          
          echo "ğŸ“Š ç»Ÿè®¡ä¿¡æ¯:"
          echo "PDFæ–‡ä»¶æ•°é‡: $(find . -name "*.pdf" | wc -l)"
          echo "DOCæ–‡ä»¶æ•°é‡: $(find . -name "*.doc*" | wc -l)"
          echo "å¹´ä»½ç›®å½•æ•°é‡: $(find . -maxdepth 1 -type d -name "[0-9][0-9][0-9][0-9]" | wc -l)"

      - name: ğŸ”§ é…ç½®GitHub Pages
        uses: actions/configure-pages@v4

      - name: ğŸ“¤ ä¸Šä¼ åˆ°GitHub Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: '.'

      - name: ğŸš€ éƒ¨ç½²åˆ°GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  # ğŸ“Š éƒ¨ç½²åéªŒè¯
  post-deploy-check:
    needs: [build-and-deploy]
    runs-on: ubuntu-latest
    if: always() && needs.build-and-deploy.result == 'success'
    
    steps:
      - name: ğŸ¥ å¥åº·æ£€æŸ¥
        run: |
          echo "ğŸ‰ éƒ¨ç½²å®Œæˆï¼"
          echo "ğŸŒ ç½‘ç«™åœ°å€: ${{ needs.build-and-deploy.outputs.page_url || 'https://ä½ çš„ç”¨æˆ·å.github.io/ä½ çš„ä»“åº“å' }}"
          echo ""
          echo "ğŸ“‹ åŠŸèƒ½æ¸…å•:"
          echo "âœ… æ–‡ä»¶æ ‘è‡ªåŠ¨æ›´æ–°"
          echo "âœ… Docsifyç½‘ç«™éƒ¨ç½²"
          echo "âœ… PDFåœ¨çº¿é¢„è§ˆ"
          echo "âœ… æœç´¢åŠŸèƒ½"
          echo "âœ… å“åº”å¼è®¾è®¡"
          echo ""
          echo "ğŸ“– ä¸‹æ¬¡æäº¤æ—¶ï¼Œå¦‚æœåŒ…å«PDF/DOCæ–‡ä»¶å˜æ›´ï¼Œå°†è‡ªåŠ¨è§¦å‘æ›´æ–°"

      - name: ğŸ“Š åˆ›å»ºéƒ¨ç½²æ€»ç»“
        run: |
          echo "## ğŸ“š ç”µèµ›çœŸé¢˜ç½‘ç«™éƒ¨ç½²æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ¯ æœ¬æ¬¡éƒ¨ç½²" >> $GITHUB_STEP_SUMMARY
          echo "- **è§¦å‘æ–¹å¼**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **åˆ†æ”¯**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **æäº¤**: [\`${{ github.sha }}\`](https://github.com/${{ github.repository }}/commit/${{ github.sha }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸŒ è®¿é—®åœ°å€" >> $GITHUB_STEP_SUMMARY
          echo "[ğŸ“– åœ¨çº¿æŸ¥çœ‹çœŸé¢˜åº“](https://ä½ çš„ç”¨æˆ·å.github.io/ä½ çš„ä»“åº“å)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ¨ åŠŸèƒ½ç‰¹æ€§" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ“„ PDFæ–‡ä»¶åœ¨çº¿é¢„è§ˆ" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ” å…¨æ–‡æœç´¢åŠŸèƒ½" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ“± å“åº”å¼è®¾è®¡ï¼Œæ”¯æŒç§»åŠ¨ç«¯" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸŒ³ è‡ªåŠ¨ç”Ÿæˆæ–‡ä»¶ç›®å½•æ ‘" >> $GITHUB_STEP_SUMMARY
          echo "- âš¡ å¿«é€Ÿå¯¼èˆªå’Œåˆ†ç±»æµè§ˆ" >> $GITHUB_STEP_SUMMARY
