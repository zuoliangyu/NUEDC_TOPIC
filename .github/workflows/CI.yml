name: ğŸš€ ç”µå­è®¾è®¡ç«èµ›çœŸé¢˜åº“ - ä¸‰åˆ†æ”¯è‡ªåŠ¨éƒ¨ç½²

on:
  push:
    branches:
      - master  # ç›‘å¬masteråˆ†æ”¯çš„PDFæ–‡ä»¶å˜æ›´
    paths-ignore:
      - 'README.md'
      - '.github/**'
  workflow_dispatch:
    inputs:
      force_rebuild:
        description: 'å¼ºåˆ¶é‡å»ºæ•´ä¸ªç½‘ç«™'
        required: false
        default: false
        type: boolean

permissions:
  contents: write
  pages: write
  id-token: write

env:
  NODE_VERSION: '18'

jobs:
  # ğŸ” æ£€æŸ¥æ˜¯å¦éœ€è¦æ„å»º
  check-changes:
    runs-on: ubuntu-latest
    outputs:
      should_build: ${{ steps.check.outputs.should_build }}
    steps:
      - name: ğŸ“¥ æ£€å‡ºmasteråˆ†æ”¯
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: ğŸ” æ£€æŸ¥æ–‡ä»¶å˜æ›´
        id: check
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "should_build=true" >> $GITHUB_OUTPUT
            echo "âš¡ æ‰‹åŠ¨è§¦å‘æ„å»º"
          else
            # æ£€æŸ¥æ˜¯å¦æœ‰çœŸé¢˜æ–‡ä»¶å˜æ›´
            CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD | grep -E '\.(pdf|doc|docx|xls|xlsx|jpg|png|zip)$' || true)
            if [[ -n "$CHANGED_FILES" ]]; then
              echo "should_build=true" >> $GITHUB_OUTPUT
              echo "ğŸ“„ æ£€æµ‹åˆ°çœŸé¢˜æ–‡ä»¶å˜æ›´ï¼š"
              echo "$CHANGED_FILES"
            else
              echo "should_build=false" >> $GITHUB_OUTPUT
              echo "â„¹ï¸ æœªæ£€æµ‹åˆ°çœŸé¢˜æ–‡ä»¶å˜æ›´ï¼Œè·³è¿‡æ„å»º"
            fi
          fi

  # ğŸ—ï¸ æ„å»ºå’Œéƒ¨ç½²ç½‘ç«™
  build-and-deploy:
    needs: check-changes
    if: needs.check-changes.outputs.should_build == 'true'
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
      # ç¬¬ä¸€æ­¥ï¼šæ£€å‡ºsourceåˆ†æ”¯ï¼ˆåŒ…å«VitePressé…ç½®ï¼‰
      - name: ğŸ“¥ æ£€å‡ºsourceåˆ†æ”¯
        uses: actions/checkout@v4
        with:
          ref: source
          token: ${{ secrets.GITHUB_TOKEN }}
          path: source

      # ç¬¬äºŒæ­¥ï¼šæ£€å‡ºmasteråˆ†æ”¯ï¼ˆåŒ…å«PDFç­‰èµ„æºæ–‡ä»¶ï¼‰
      - name: ğŸ“¥ æ£€å‡ºmasteråˆ†æ”¯èµ„æº
        uses: actions/checkout@v4
        with:
          ref: master
          path: resources

      # ç¬¬ä¸‰æ­¥ï¼šè®¾ç½®Node.jsç¯å¢ƒ
      - name: ğŸŸ¢ è®¾ç½®Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      # ç¬¬å››æ­¥ï¼šåŒæ­¥èµ„æºæ–‡ä»¶åˆ°sourceåˆ†æ”¯
      - name: ğŸ”„ åŒæ­¥èµ„æºæ–‡ä»¶
        run: |
          # è¿›å…¥sourceç›®å½•
          cd source
          
          # æ¸…ç†æ—§çš„èµ„æºæ–‡ä»¶
          rm -rf docs/public/çœŸé¢˜ docs/public/ç»¼åˆæµ‹è¯„ docs/public/assets
          
          # å¤åˆ¶æ–°çš„èµ„æºæ–‡ä»¶
          mkdir -p docs/public
          cp -r ../resources/çœŸé¢˜ docs/public/
          cp -r ../resources/ç»¼åˆæµ‹è¯„ docs/public/
          cp -r ../resources/assets docs/public/
          
          echo "âœ… èµ„æºæ–‡ä»¶åŒæ­¥å®Œæˆ"
          echo "ğŸ“Š åŒæ­¥çš„æ–‡ä»¶ç»Ÿè®¡ï¼š"
          echo "PDFæ–‡ä»¶: $(find docs/public -name "*.pdf" | wc -l)"
          echo "DOCæ–‡ä»¶: $(find docs/public -name "*.doc*" | wc -l)"

      # ç¬¬äº”æ­¥ï¼šç”ŸæˆåŠ¨æ€å†…å®¹
      - name: ğŸ“ ç”Ÿæˆæ–‡æ¡£é¡µé¢
        run: |
          cd source
          
          # è¿è¡Œæ–‡æ¡£ç”Ÿæˆè„šæœ¬
          npm run generate
          
          echo "âœ… æ–‡æ¡£é¡µé¢ç”Ÿæˆå®Œæˆ"

      # ç¬¬å…­æ­¥ï¼šå®‰è£…ä¾èµ–å¹¶æ„å»º
      - name: ğŸ“¦ è®¾ç½®npmç¼“å­˜
        uses: actions/cache@v3
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('source/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        run: |
          cd source
          npm ci

      - name: ğŸ”¨ æ„å»ºç½‘ç«™
        run: |
          cd source
          npm run build
          
          echo "âœ… ç½‘ç«™æ„å»ºå®Œæˆ"
          echo "ğŸ“ æ„å»ºäº§ç‰©ï¼š"
          ls -la docs/.vitepress/dist/

      # ç¬¬ä¸ƒæ­¥ï¼šé…ç½®GitHub Pages
      - name: ğŸ”§ é…ç½®GitHub Pages
        uses: actions/configure-pages@v4

      # ç¬¬å…«æ­¥ï¼šä¸Šä¼ æ„å»ºäº§ç‰©
      - name: ğŸ“¤ ä¸Šä¼ åˆ°GitHub Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: source/docs/.vitepress/dist

      # ç¬¬ä¹æ­¥ï¼šéƒ¨ç½²åˆ°GitHub Pages
      - name: ğŸš€ éƒ¨ç½²åˆ°GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      # ç¬¬åæ­¥ï¼šæ›´æ–°READMEä¸­çš„é“¾æ¥ï¼ˆå¯é€‰ï¼‰
      - name: ğŸ“„ æ›´æ–°README
        if: success()
        run: |
          cd resources
          
          # åˆ›å»ºPythonè„šæœ¬æ–‡ä»¶
          cat > update_readme.py << 'EOF'
          import re
          from datetime import datetime
          import os
          
          # è¯»å–README
          with open('README.md', 'r', encoding='utf-8') as f:
              content = f.read()
          
          # è·å–éƒ¨ç½²URL
          deploy_url = os.environ.get('DEPLOY_URL', 'https://ä½ çš„ç”¨æˆ·å.github.io/ä½ çš„ä»“åº“å')
          
          # æ·»åŠ ç½‘ç«™é“¾æ¥ä¿¡æ¯
          site_info = f'''
          
          ## ğŸŒ åœ¨çº¿è®¿é—®
          
          **[ğŸ“– ç‚¹å‡»è®¿é—®åœ¨çº¿çœŸé¢˜åº“]({deploy_url})**
          
          - ğŸ” æ”¯æŒå…¨æ–‡æœç´¢
          - ğŸ“± é€‚é…ç§»åŠ¨è®¾å¤‡  
          - ğŸ“„ åœ¨çº¿PDFé¢„è§ˆ
          - âš¡ å¿«é€ŸåŠ è½½
          
          > æœ€åæ›´æ–°: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}
          
          '''
          
          # æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨åœ¨çº¿è®¿é—®éƒ¨åˆ†
          if '## ğŸŒ åœ¨çº¿è®¿é—®' not in content:
              # åœ¨æ–‡ä»¶æ ‘å‰æ·»åŠ ç½‘ç«™ä¿¡æ¯
              tree_start = content.find('<!-- readme-tree start -->')
              if tree_start != -1:
                  content = content[:tree_start] + site_info + '\n' + content[tree_start:]
              else:
                  content = content + site_info
          
          # å†™å›æ–‡ä»¶
          with open('README.md', 'w', encoding='utf-8') as f:
              f.write(content)
          
          print("âœ… READMEå·²æ›´æ–°")
          EOF
          
          # è®¾ç½®ç¯å¢ƒå˜é‡å¹¶è¿è¡Œè„šæœ¬
          export DEPLOY_URL="${{ steps.deployment.outputs.page_url }}"
          python3 update_readme.py
          
          # æäº¤æ›´æ–°ï¼ˆå¦‚æœæœ‰å˜æ›´ï¼‰
          git config user.name 'GitHub Actions'
          git config user.email 'actions@github.com'
          git add README.md || true
          git diff --staged --quiet || git commit -m "ğŸ“š æ›´æ–°åœ¨çº¿è®¿é—®é“¾æ¥ [skip ci]" || true
          git push origin master || true

  # ğŸ“Š éƒ¨ç½²æˆåŠŸé€šçŸ¥
  notify-success:
    needs: [build-and-deploy]
    if: success()
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ‰ éƒ¨ç½²æˆåŠŸé€šçŸ¥
        run: |
          echo "## ğŸ‰ éƒ¨ç½²æˆåŠŸï¼" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“Š é¡¹ç›®æ¶æ„" >> $GITHUB_STEP_SUMMARY
          echo "- **masteråˆ†æ”¯**: å­˜å‚¨PDF/DOCçœŸé¢˜æ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
          echo "- **sourceåˆ†æ”¯**: VitePressæºç å’Œé…ç½®" >> $GITHUB_STEP_SUMMARY  
          echo "- **gh-pagesåˆ†æ”¯**: æ„å»ºåçš„é™æ€ç½‘ç«™" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸŒ è®¿é—®åœ°å€" >> $GITHUB_STEP_SUMMARY
          echo "**[ğŸš€ ç«‹å³è®¿é—®çœŸé¢˜åº“](${{ needs.build-and-deploy.outputs.page_url }})**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ¨ åŠŸèƒ½ç‰¹æ€§" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ” æ™ºèƒ½æœç´¢: å¿«é€ŸæŸ¥æ‰¾é¢˜ç›®" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ“„ åœ¨çº¿é¢„è§ˆ: æ— éœ€ä¸‹è½½å³å¯æŸ¥çœ‹PDF" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ“± å“åº”å¼è®¾è®¡: å®Œç¾é€‚é…æ‰‹æœºå’Œç”µè„‘" >> $GITHUB_STEP_SUMMARY
          echo "- âš¡ æé€ŸåŠ è½½: ç°ä»£åŒ–çš„æ€§èƒ½ä¼˜åŒ–" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ¯ åˆ†ç±»å¯¼èˆª: æŒ‰å¹´ä»½å’Œé¢˜å‹å¿«é€Ÿå®šä½" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“ ä¸‹æ¬¡æ›´æ–°" >> $GITHUB_STEP_SUMMARY
          echo "åªéœ€è¦å‘masteråˆ†æ”¯æ·»åŠ æ–°çš„PDFæ–‡ä»¶ï¼Œç½‘ç«™å°†è‡ªåŠ¨æ›´æ–°ï¼" >> $GITHUB_STEP_SUMMARY